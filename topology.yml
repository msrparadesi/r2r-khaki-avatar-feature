name: petavatar

# API Gateway configuration
# Requirements: 6.6 (API key validation, CORS, throttling)
routes:
  /presigned-url:
    method: GET
    function: presigned-url-handler
    cors:
      methods: ['GET', 'OPTIONS']
      origins: ['*']
      allowed_headers: ['Content-Type', 'x-api-key', 'Authorization']
      expose_headers: ['x-request-id']
      max_age: 86400  # 24 hours
    # Throttling: 100 requests per second, burst of 200
    throttle:
      rate_limit: 100
      burst_limit: 200
  
  /process:
    method: POST
    function: process-handler
    cors:
      methods: ['POST', 'OPTIONS']
      origins: ['*']
      allowed_headers: ['Content-Type', 'x-api-key', 'Authorization']
      expose_headers: ['x-request-id']
      max_age: 86400
    # Lower throttle for processing endpoint
    throttle:
      rate_limit: 50
      burst_limit: 100
  
  /status/{job_id}:
    method: GET
    function: status-handler
    cors:
      methods: ['GET', 'OPTIONS']
      origins: ['*']
      allowed_headers: ['Content-Type', 'x-api-key', 'Authorization']
      expose_headers: ['x-request-id']
      max_age: 86400
    throttle:
      rate_limit: 200
      burst_limit: 400
  
  /results/{job_id}:
    method: GET
    function: result-handler
    cors:
      methods: ['GET', 'OPTIONS']
      origins: ['*']
      allowed_headers: ['Content-Type', 'x-api-key', 'Authorization']
      expose_headers: ['x-request-id']
      max_age: 86400
    throttle:
      rate_limit: 100
      burst_limit: 200

functions:
  presigned-url-handler:
    # Generates presigned S3 URLs for direct uploads
    runtime:
      lang: python3.13
    env:
      # S3 bucket for pet image uploads
      # Format: petavatar-uploads-{account_id}
      S3_UPLOAD_BUCKET: ${S3_UPLOAD_BUCKET}
      # Secrets Manager ARN for API key validation
      API_KEY_SECRET_ARN: ${API_KEY_SECRET_ARN}
  
  process-handler:
    # Validates S3 URI and initiates processing
    runtime:
      lang: python3.13
    queue: processing-queue
    env:
      # DynamoDB table for job tracking
      DYNAMODB_TABLE_NAME: ${DYNAMODB_TABLE_NAME}
      # Secrets Manager ARN for API key validation
      API_KEY_SECRET_ARN: ${API_KEY_SECRET_ARN}
  
  s3-event-handler:
    # Handles S3 upload events (configured via S3 event notifications)
    runtime:
      lang: python3.13
    queue: processing-queue
    env:
      # DynamoDB table for job tracking
      DYNAMODB_TABLE_NAME: ${DYNAMODB_TABLE_NAME}
      # SQS queue URL for processing queue (injected by tc-functors via queue: directive)
      # If tc-functors doesn't auto-inject, set manually after deployment
      SQS_QUEUE_URL: ${SQS_QUEUE_URL}
  
  status-handler:
    # Returns job status from DynamoDB
    runtime:
      lang: python3.13
    env:
      # DynamoDB table for job tracking
      DYNAMODB_TABLE_NAME: ${DYNAMODB_TABLE_NAME}
      # Secrets Manager ARN for API key validation
      API_KEY_SECRET_ARN: ${API_KEY_SECRET_ARN}
  
  result-handler:
    # Returns completed results with presigned URLs
    runtime:
      lang: python3.13
    env:
      # DynamoDB table for job tracking
      DYNAMODB_TABLE_NAME: ${DYNAMODB_TABLE_NAME}
      # S3 bucket for generated avatars
      # Format: petavatar-generated-{account_id}
      S3_GENERATED_BUCKET: ${S3_GENERATED_BUCKET}
      # Secrets Manager ARN for API key validation
      API_KEY_SECRET_ARN: ${API_KEY_SECRET_ARN}
  
  process-worker:
    # Orchestrates avatar generation via Strands Agent
    runtime:
      lang: python3.13
      role_file: scripts/iam-policies/petavatar-lambda-policy.json
    timeout: 900  # 15 minutes for long-running AI operations
    env:
      # DynamoDB table for job tracking
      DYNAMODB_TABLE_NAME: ${DYNAMODB_TABLE_NAME}
      # S3 bucket for pet image uploads
      # Format: petavatar-uploads-{account_id}
      S3_UPLOAD_BUCKET: ${S3_UPLOAD_BUCKET}
      # S3 bucket for generated avatars
      # Format: petavatar-generated-{account_id}
      S3_GENERATED_BUCKET: ${S3_GENERATED_BUCKET}
      # Bedrock AgentCore runtime ARN for Strands Agent
      AGENT_RUNTIME_ARN: ${AGENT_RUNTIME_ARN}

queues:
  processing-queue:
    function: process-worker
    batch_size: 1
    visibility_timeout: 900  # 15 minutes to match Lambda timeout
